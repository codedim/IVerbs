<!DOCTYPE html>
<html><head>
<title>Irregular verbs</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<style>
 body { font-family: sans-serif }
 input, h4 { font-size: 12pt; font-weight: bold }
 h3, h4 { margin: 10px 0px 5px; text-align: center }
 #player { position: absolute; width: 300px; display: none; }
 #playBtn { 
 	height: 24px;
	background-position: center;
	background-repeat: no-repeat;
	background-image: url("data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'><path d='M 3 18 L 3 4 L 17 11 L 3 18' fill='silver' stroke='grey' stroke-width='2' /></svg>"); 
}
 #rewBtn { float: left }
 #frwBtn { float: right }
 #word { color: #337 }
 #correct, #total { color: #333; }
 .badAns { color: red }
 .goodAns { color: green }
 #totals { display: none }
 #fixme { display: none }
 div#quiz, div#learn { 
 	display: inline-block; width: 300px; 
 	padding: 6px;
 	background-color: #eee; 
 }
 button#mode { width: 100%; font-size: 11pt }
 #audioTag { color: #e00; }
</style>
<script type="text/javascript" src="iverbs.js"></script>
</head><body>

<div id="quiz">
<h3 id="capture">Quiz: English irregular verbs</h3>
<h4 id="word"></h4>
<form id="answer" method="post" onsubmit="return updateQuizWord()">
<input type="text" id="ps" size="10" maxlength="12" autocomplete="off" name="PastSimple" />
<input type="text" id="pp" size="10" maxlength="12" autocomplete="off" name="PastParticiple" />
<input type="submit" value="&gt;" />
</form>
<div id="player">
 <button id="playBtn" onclick="playLearning();">&nbsp;&nbsp;</button>
 &nbsp;&nbsp;<code id="trackBar"></code><p>
 <button id="rewBtn" onclick="rewindAudio();">&lt;&lt;</button>
 <button id="frwBtn" onclick="forwardAudio();">&gt;&gt;</button>
</div>
<h4 id="correct">&nbsp; <span class=""></span> <span class=""></span></h4>
<h4 id="attempts">Attempts: <span id="at" class="goodAns">0</span>&nbsp;&nbsp;
 Errors: <span id="er" class="badAns">0</span>&nbsp;&nbsp;
 <a id="fixme" href="javascript:void(0)" onclick="fixMistakes()">correct</a></h4>
<h4 id="totals">Word: <span id="cw" class="goodAns">0</span>&nbsp;&nbsp;
 Total: <span id="tw" class="goodAns">0</span></h4>
<p><button id="mode" onclick="switchMode();">Learn</button>
</div>
<audio id="audioTag">HTML5 audio not supported!</audio>

<script>

var capture = document.getElementById('capture');
var currentWord = document.getElementById('word');
var correctAnswer = document.getElementById('correct');
var totalAttempt = document.getElementById('attempts');
var totalResult = document.getElementById('totals');
var answerForm = document.getElementById('answer');
var inputPastSimple = document.getElementById('ps');
var inputPastParticiple = document.getElementById('pp');
var fixmeLink = document.getElementById('fixme');
var modeBtn =  document.getElementById('mode');
var player = document.getElementById('player');
var playBtn = document.getElementById('playBtn');
var objAudio = document.getElementById('audioTag');
objAudio.src = 'iverbs.mp3';
var stopTimer, playTimer;

var keyFlag; // "enter was pressed on the element" flag
var wordNmb = -1;
var errNmb = 0;
var attemptCount = 0;
var errCount = 0;
var errList = []; // array to store failed answers
var testMode = 'quiz'; // mode of the test: 'common quiz' or 'correct mistakes'

window.onload = function() {
	updateQuizWord();

	inputPastSimple.onkeydown = function() {
		keyFlag = inputPastSimple;
	}
	inputPastParticiple.onkeydown = function() {
		keyFlag = inputPastParticiple;
	}
}

function switchMode() {
	// initialization
	objAudio.pause();
	objAudio.currentTime = 0;
	clearTimeout(stopTimer);
	clearInterval(playTimer);
	wordNmb = -1;
	errNmb = 0;
	attemptCount = 0;
	errCount = 0;
	errList = []; 
	testMode = 'quiz';
	currentWord.innerHTML = '&nbsp;';
	correctAnswer.innerHTML = '&nbsp;';
	fixmeLink.style.display = 'none';

	if (modeBtn.innerHTML == 'Learn') {
	// switch to Learn mode
		capture.innerHTML = 'Learn: ' + iverbsTopic;
		modeBtn.innerHTML = 'Quiz';
		answerForm.style.visibility = 'hidden';
		totalResult.style.display = 'block';
		totalAttempt.style.display = 'none';
		document.getElementById('tw').innerHTML = iverbs.length;
		player.style.display = 'block';
	} else {
	// switch to Quiz mode
		capture.innerHTML = 'Quiz: ' + iverbsTopic;
		modeBtn.innerHTML = 'Learn';
		answerForm.style.visibility = 'visible';
		totalResult.style.display = 'none';
		totalAttempt.style.display = 'block';
		player.style.display = 'none';
		updateQuizWord();
	}
}

function playLearning() {
	if (objAudio.paused) {
		objAudio.play();
//		playBtn.textContent = "Pause";
		playBtn.style.backgroundImage = "url(\"data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'><rect x='3' y='4' width='5' height='13' fill='silver' stroke='grey' stroke-width='2' /><rect x='12' y='4' width='5' height='13' fill='silver' stroke='grey' stroke-width='2' /></svg>\")";
		playTimer = setInterval(updateLearningWords, 100);
	}
	else {
		objAudio.pause();
//		playBtn.textContent = "Play";
		playBtn.style.backgroundImage = "url(\"data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'><path d='M 3 18 L 3 4 L 17 11 L 3 18' fill='silver' stroke='grey' stroke-width='2' /></svg>\")";
		clearInterval(playTimer);
	}
}

function updateLearningWords() {
	var wordIdx = iverbs.length - 1;
	var word = iverbs[wordIdx]; // last item from array

	for (i = 0; i < iverbs.length - 1; ++i) 
		if ( (iverbs[i][3] < objAudio.currentTime) && 
			(iverbs[i + 1][3] > objAudio.currentTime) ) 
		{
			word = iverbs[i];
			wordIdx = i;
		}

	currentWord.innerHTML = word[0] + ' ' + word[1] + ' ' + word[2];
	document.getElementById('cw').innerHTML = wordIdx + 1;
	updateTrackBar();
}

function updateTrackBar() {
	var trackBar = document.getElementById('trackBar');
	if (objAudio && trackBar) {
		// the file plaing is over
		if (objAudio.currentTime == objAudio.duration) {
			clearInterval(playTimer);
			objAudio.currentTime = 0;
			objAudio.pause();
//			playBtn.textContent = "Play";
			playBtn.style.backgroundImage = "url(\"data:image/svg+xml;charset=utf8,<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'><path d='M 3 18 L 3 4 L 17 11 L 3 18' fill='silver' stroke='grey' stroke-width='2' /></svg>\")";
		}
		// uplate track bar
		trackBar.innerHTML = formatTimeStr(objAudio.currentTime) + 
			' | ' + formatTimeStr(objAudio.duration);		
	}

	// formats to '00:00:00.00'
	function formatTimeStr(sec) {
		if (!sec) return '00:00:00.00';
		var h = sec / 1200 | 0;	if (h <= 9) h = '0' + h;
		var m = sec / 60 | 0;	if (m <= 9) m = '0' + m;
		var s = sec % 60;		if (s < 10) s = '0' + s;
		return h + ':' + m + ':' + String(s).substr(0, 5);
	}
}

function rewindAudio() {
	objAudio.currentTime -= 30.0;
}

function forwardAudio() {
	objAudio.currentTime += 30.0;
}

function updateQuizWord() {
	// if 'submit' event (Enter is pressed) is from the first imput
	if (keyFlag == inputPastSimple) {
		inputPastParticiple.setSelectionRange(0, 10);
		inputPastParticiple.focus();
		return false;
	}

	// remember the previous answer
	var pastSimple = inputPastSimple.value;
	var pastParticiple = inputPastParticiple.value;

	// show previous correct answer result
	if (wordNmb > -1) {
		var ansClass = (iverbs[wordNmb][1] == pastSimple.trim()) ? 
			'goodAns' : 'badAns';
		if (ansClass == 'badAns') { 
			++errCount; 
			errList.push(wordNmb); 
		}
		var answerHtml = iverbs[wordNmb][0] + ' <span class="' + 
			ansClass + '">' + iverbs[wordNmb][1];

		ansClass = (iverbs[wordNmb][2] == pastParticiple.trim()) ? 
			'goodAns' : 'badAns';
		if (ansClass == 'badAns') { 
			++errCount; 
			if (errList[errList.length - 1] != wordNmb) errList.push(wordNmb); 
		}
		answerHtml += '</span> <span class="' + ansClass + '">' + 
			iverbs[wordNmb][2] + '</span>';

		// show words
		correctAnswer.innerHTML = answerHtml;
		// play words
		objAudio.currentTime = iverbs[wordNmb][3];
		objAudio.play();
		var duration = (wordNmb < iverbs.length - 1) ? 
			iverbs[wordNmb + 1][3] : objAudio.duration;
		duration -= iverbs[wordNmb][3];
		setTimeout(function() {
			objAudio.pause();
		}, duration * 1000);
	}

	// get a new word
	stopTimer = setTimeout(function() {
		if (testMode == 'quiz') {
			wordNmb = Math.floor( Math.random() * iverbs.length );
		} else {
			if (errNmb == errList.length) {
				alert('All mistakes are corrected.\nWell done!');
				return true;
			}
			wordNmb = errList[errNmb++];
		}
		currentWord.innerHTML = iverbs[wordNmb][0];	
		// set focus to PastSimple imput
		inputPastSimple.setSelectionRange(0, 10);
		inputPastSimple.focus();
	}, duration * 1000);

	// show statistics
	document.getElementById('at').innerHTML = attemptCount++;
	document.getElementById('er').innerHTML = errCount;
	if (errCount > 2) fixmeLink.style.display = 'inline';

	return false;
}

function fixMistakes() {
	errCount = 0;
	errNmb = 0;
	wordNmb = -1;
	testMode = 'correct';
	fixmeLink.style.display = 'none';
	updateQuizWord();
}
</script> 
</body></html>
